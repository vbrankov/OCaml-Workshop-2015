\documentclass{beamer}
\usepackage{listings}
\usepackage[scaled=0.8]{DejaVuSansMono}
\lstset{,
  basicstyle=\footnotesize\ttfamily,
  showstringspaces=false,
  tabsize=2,
  xleftmargin=\parindent,
  xrightmargin=\parindent,
  columns=flexible,
  frame=tb
}
\title[Inline Assembly]
{Inline Assembly for OCaml}
\author[Brankov, Vladimir]{V.~Brankov\inst{1}}
\institute[Jane Street]
{
  \inst{1}
  Jane Street
}
\date[August 2015]
{OCaml Workshop, 2015}

\begin{document}
\begin{frame}
  \frametitle{OCaml Inline Assembly}
  \begin{itemize}
    \item Motivation: Intel AVX Vector Instructions
      \begin{itemize}
        \item 4 x Float Vector = 4x performance
      \end{itemize}
      \bigskip
    \item Embed assembly code in OCaml code
      \begin{itemize}
        \item Use OCaml variables and compiler optimizations
        \item Equivalent to custom native primitives (no C call)
      \end{itemize}
      \bigskip
    \item Speed
      \begin{itemize}
        \item Vector instructions
        \item Special instructions (Float.max)
        \item Language limits (Bigarray for HDF5)
      \end{itemize}
  \end{itemize}
\end{frame}
\begin{frame}[fragile]
  \frametitle{OCaml Inline Assembly}
  \begin{lstlisting}
external float_min_c : float -> float -> float
     = "float_min" "float_min_stub" "float"

external float_min_asm : float -> float -> float
     = "%asm" "float_min_asm_stub"
       "minsd	%0, %2	# float_min" "mx" "2" "=x" ""

        movsd       .L133(%rip), %xmm1
        movsd       .L104(%rip), %xmm0
        call        float_min_stub@PLT           # external C call
        movsd       %xmm0, 24(%rsp)
        movsd       .L133(%rip), %xmm0
        movsd       .L104(%rip), %xmm1
        minsd       %xmm1, %xmm0	                # inline assembly
        movsd       %xmm0, 16(%rsp)
  \end{lstlisting}
\end{frame}
\begin{frame}
  \frametitle{OCaml Inline Assembly}
  \begin{itemize}
    \item Implementation: \lstinline[language=Bash]$opam switch 4.03.0+pr162$
    \item Borrows GCC syntax:\\
      \ \ \ \lstinline[language={[Objective]Caml}]$
        external floor\_asm : float -> float$ \\
      \ \ \ \ \ \ \lstinline[language={[Objective]Caml}]$
        = "\%asm" "floor\_stub" "roundsd	\$1, \%0, \%1	\# floor" "mx" "=x"$
    \item The syntax controls OCaml compiler optimizations
      \begin{itemize}
        \item Variables in registers or memory
        \item Commutative variables
        \item Modifying memory
      \end{itemize}
  \end{itemize}
\end{frame}
\begin{frame}
  \frametitle{OCaml Inline Assembly}
  \begin{itemize}
    \item Alternatives:
      \begin{itemize}
        \item Blocks of C code
        \item "noalloc" externals
      \end{itemize}
      \medskip
    \item Synthetic benchmarks: \\
      \medskip
      \footnotesize \
      \begin{tabular}{ll}
        \texttt{float min} & \texttt{6x} \\
        \texttt{floor} & \texttt{5x} \\
        \texttt{+. *.} & \texttt{2.3x} \\
        \texttt{Complex} & \texttt{1.3 - 12x} \\
      \end{tabular}
      \medskip
    \item Real world applications
      \begin{itemize}
        \item Correlation matrix
        \item Compex
        \item HDF5
      \end{itemize}
  \end{itemize}
\end{frame}
\end{document}
